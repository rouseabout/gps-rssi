#include <assert.h>
#include "prn.h"

/* G2 shift register delay for each PRN is specified in IS-GPS-200,
 * table 3-I. It's stored time-reversed here: the spec is for the number
 * of chips to delay G2's output before using it, but we want to know
 * how many chips into the future to look. */
static const struct SVDATA {
    unsigned char Navstar;
    unsigned short advance;
} SV[MAX_SV] = {
    { 63, 1023 -   5, },
    { 56, 1023 -   6, },
    { 37, 1023 -   7, },
    { 35, 1023 -   8, },
    { 64, 1023 -  17, },
    { 36, 1023 -  18, },
    { 62, 1023 - 139, },
    { 44, 1023 - 140, },
    { 33, 1023 - 141, },
    { 38, 1023 - 251, },
    { 46, 1023 - 252, },
    { 59, 1023 - 254, },
    { 43, 1023 - 255, },
    { 49, 1023 - 256, },
    { 60, 1023 - 257, },
    { 51, 1023 - 258, },
    { 57, 1023 - 469, },
    { 50, 1023 - 470, },
    { 54, 1023 - 471, },
    { 47, 1023 - 472, },
    { 52, 1023 - 473, },
    { 53, 1023 - 474, },
    { 55, 1023 - 509, },
    { 23, 1023 - 512, },
    { 24, 1023 - 513, },
    { 26, 1023 - 514, },
    { 27, 1023 - 515, },
    { 48, 1023 - 516, },
    { 61, 1023 - 859, },
    { 39, 1023 - 860, },
    { 58, 1023 - 861, },
    { 22, 1023 - 862, },
};

/* These are precomputed outputs of the G1 and G2 shift registers as
 * specified by IS-GPS-200. */
static const struct {
	unsigned char G1 : 1;
	unsigned char G2 : 1;
} ca_code_states[1023] = {
	{1,1}, {1,1}, {1,1}, {1,1}, {1,1}, {1,1}, {1,1}, {1,1}, {1,1}, {1,1},
	{0,0}, {0,0}, {0,1}, {1,0}, {1,1}, {1,1}, {0,0}, {0,1}, {0,0}, {1,0},
	{0,1}, {0,0}, {1,1}, {1,0}, {1,1}, {0,1}, {1,1}, {1,1}, {0,0}, {0,1},
	{1,0}, {0,1}, {1,0}, {0,0}, {1,0}, {1,0}, {1,0}, {0,1}, {1,1}, {1,1},
	{1,1}, {1,1}, {0,0}, {1,1}, {0,0}, {1,1}, {0,0}, {0,1}, {0,0}, {1,1},
	{1,1}, {1,0}, {1,1}, {0,0}, {1,0}, {0,0}, {0,0}, {1,0}, {0,1}, {1,0},
	{0,1}, {1,0}, {0,0}, {0,1}, {0,1}, {0,1}, {0,0}, {1,1}, {0,1}, {1,1},
	{1,0}, {1,0}, {1,1}, {1,0}, {1,0}, {1,0}, {1,0}, {0,1}, {1,1}, {0,0},
	{1,1}, {0,0}, {1,0}, {0,0}, {1,1}, {0,1}, {1,0}, {1,0}, {1,1}, {1,1},
	{0,1}, {1,1}, {0,1}, {0,0}, {0,1}, {0,1}, {1,1}, {1,1}, {1,0}, {0,1},
	{1,1}, {0,0}, {0,1}, {1,0}, {0,0}, {0,1}, {0,1}, {1,1}, {1,1}, {0,0},
	{0,0}, {1,1}, {0,0}, {1,1}, {1,0}, {0,0}, {1,0}, {0,1}, {1,1}, {1,1},
	{0,1}, {0,0}, {1,1}, {1,1}, {1,0}, {1,0}, {0,0}, {1,1}, {0,0}, {1,0},
	{1,1}, {0,0}, {0,1}, {0,1}, {1,1}, {1,1}, {0,0}, {0,1}, {1,1}, {1,1},
	{1,1}, {1,1}, {1,1}, {1,0}, {0,1}, {0,0}, {1,0}, {0,1}, {1,0}, {0,0},
	{1,1}, {0,0}, {1,1}, {0,1}, {0,0}, {1,1}, {1,1}, {0,0}, {0,0}, {1,1},
	{1,0}, {0,0}, {0,0}, {1,0}, {0,0}, {1,1}, {0,1}, {0,0}, {1,1}, {1,0},
	{1,1}, {1,0}, {1,0}, {0,0}, {1,1}, {0,0}, {0,0}, {1,0}, {1,0}, {1,1},
	{0,0}, {0,1}, {0,0}, {0,0}, {1,0}, {0,1}, {0,0}, {0,1}, {1,0}, {1,1},
	{0,0}, {1,1}, {1,1}, {0,1}, {0,1}, {1,1}, {0,1}, {0,1}, {0,0}, {1,1},
	{0,0}, {1,1}, {0,1}, {0,1}, {1,1}, {1,0}, {0,0}, {1,0}, {1,0}, {1,1},
	{1,1}, {0,0}, {1,1}, {1,1}, {1,0}, {0,1}, {1,0}, {0,0}, {1,0}, {0,1},
	{1,0}, {1,0}, {1,1}, {0,0}, {0,0}, {1,1}, {1,0}, {0,0}, {0,1}, {1,1},
	{1,0}, {1,0}, {0,0}, {1,1}, {1,0}, {1,1}, {0,0}, {1,1}, {1,1}, {1,1},
	{0,0}, {0,0}, {1,0}, {1,1}, {1,0}, {0,0}, {1,1}, {0,1}, {1,1}, {0,0},
	{0,0}, {1,0}, {1,0}, {1,0}, {0,0}, {1,0}, {0,1}, {0,0}, {0,0}, {0,1},
	{0,0}, {1,1}, {1,0}, {1,1}, {1,0}, {0,1}, {1,0}, {1,1}, {0,0}, {1,0},
	{1,0}, {1,1}, {0,1}, {0,0}, {0,1}, {0,1}, {1,0}, {1,0}, {0,0}, {0,1},
	{0,1}, {1,0}, {0,0}, {0,1}, {1,0}, {0,1}, {1,0}, {0,0}, {0,1}, {1,1},
	{0,0}, {1,0}, {1,0}, {0,0}, {0,0}, {1,0}, {1,1}, {0,0}, {1,1}, {0,0},
	{0,1}, {0,1}, {1,0}, {0,0}, {0,1}, {0,1}, {1,0}, {0,0}, {1,1}, {1,0},
	{0,0}, {1,1}, {0,1}, {0,1}, {1,1}, {0,1}, {1,1}, {1,0}, {1,0}, {0,1},
	{1,1}, {0,1}, {0,0}, {1,1}, {1,0}, {0,0}, {0,1}, {0,0}, {1,1}, {0,1},
	{1,1}, {1,0}, {0,0}, {0,0}, {0,0}, {0,0}, {0,1}, {0,0}, {1,0}, {0,1},
	{1,1}, {0,1}, {0,1}, {1,0}, {0,1}, {0,1}, {1,1}, {0,0}, {1,1}, {1,0},
	{1,1}, {1,0}, {1,0}, {0,1}, {1,0}, {1,1}, {1,0}, {1,0}, {0,1}, {0,0},
	{0,0}, {1,1}, {1,1}, {0,1}, {0,0}, {0,1}, {1,0}, {1,1}, {0,1}, {1,1},
	{1,0}, {1,0}, {0,1}, {1,1}, {1,1}, {0,1}, {0,0}, {0,1}, {0,0}, {1,1},
	{1,1}, {1,0}, {1,1}, {0,1}, {0,1}, {1,1}, {0,0}, {0,0}, {1,0}, {1,1},
	{1,1}, {0,0}, {0,1}, {1,0}, {0,1}, {1,1}, {1,0}, {0,1}, {0,0}, {0,1},
	{1,0}, {0,1}, {0,1}, {0,0}, {0,0}, {1,0}, {1,1}, {0,1}, {1,1}, {1,0},
	{1,0}, {1,1}, {1,0}, {1,0}, {1,1}, {0,0}, {0,0}, {1,0}, {1,1}, {1,1},
	{0,1}, {0,1}, {0,1}, {1,1}, {1,0}, {0,1}, {1,1}, {0,0}, {1,0}, {0,1},
	{0,1}, {1,1}, {0,1}, {1,0}, {0,0}, {0,0}, {0,0}, {0,0}, {1,1}, {0,1},
	{0,0}, {0,0}, {0,0}, {1,0}, {0,1}, {0,1}, {1,0}, {0,0}, {1,1}, {1,1},
	{0,0}, {1,1}, {1,0}, {1,1}, {1,0}, {1,1}, {0,0}, {1,0}, {0,1}, {1,1},
	{1,0}, {1,1}, {0,0}, {0,1}, {0,1}, {1,1}, {0,1}, {1,1}, {1,0}, {1,1},
	{0,1}, {0,0}, {1,1}, {0,1}, {0,0}, {0,0}, {0,0}, {1,0}, {1,1}, {1,1},
	{1,1}, {1,0}, {0,0}, {1,0}, {1,1}, {0,1}, {1,1}, {0,0}, {1,1}, {0,1},
	{1,1}, {0,1}, {0,0}, {0,0}, {1,1}, {0,1}, {1,0}, {1,1}, {1,0}, {1,0},
	{0,0}, {1,0}, {1,1}, {0,1}, {0,1}, {1,0}, {1,1}, {1,0}, {0,0}, {0,0},
	{1,0}, {1,0}, {1,0}, {1,0}, {1,0}, {0,1}, {0,1}, {0,1}, {0,0}, {0,0},
	{1,1}, {1,1}, {1,0}, {0,0}, {0,1}, {1,1}, {0,0}, {0,0}, {1,0}, {0,0},
	{1,1}, {0,0}, {1,0}, {1,1}, {0,0}, {0,0}, {1,0}, {0,0}, {1,1}, {1,0},
	{1,0}, {1,0}, {0,1}, {0,1}, {1,0}, {0,0}, {1,0}, {1,1}, {1,0}, {0,0},
	{0,0}, {0,0}, {0,0}, {0,0}, {1,0}, {0,1}, {1,1}, {0,0}, {1,0}, {1,1},
	{0,0}, {1,0}, {1,0}, {0,1}, {0,0}, {1,0}, {1,0}, {0,1}, {0,1}, {0,1},
	{0,0}, {1,1}, {1,0}, {0,1}, {1,0}, {0,1}, {1,1}, {1,1}, {0,0}, {1,1},
	{1,0}, {1,0}, {0,1}, {1,1}, {0,1}, {0,0}, {0,0}, {1,1}, {0,0}, {1,1},
	{0,1}, {1,1}, {1,1}, {1,1}, {1,1}, {1,0}, {1,0}, {0,0}, {1,1}, {0,0},
	{0,1}, {0,0}, {1,0}, {1,1}, {1,0}, {0,1}, {0,1}, {1,0}, {1,0}, {0,1},
	{1,1}, {1,1}, {1,0}, {0,0}, {0,1}, {1,1}, {0,1}, {1,0}, {0,0}, {0,0},
	{0,1}, {1,0}, {1,1}, {0,1}, {1,0}, {0,0}, {0,1}, {0,0}, {0,1}, {0,1},
	{0,1}, {1,0}, {1,1}, {0,0}, {0,1}, {1,1}, {0,0}, {0,0}, {1,1}, {0,0},
	{0,0}, {0,1}, {1,0}, {0,1}, {0,0}, {0,0}, {0,0}, {0,0}, {1,1}, {0,0},
	{0,0}, {1,1}, {1,1}, {0,0}, {1,1}, {1,1}, {0,0}, {1,0}, {0,1}, {0,1},
	{1,0}, {1,1}, {1,1}, {1,1}, {0,1}, {0,0}, {1,1}, {1,0}, {0,0}, {1,0},
	{0,1}, {1,1}, {0,1}, {1,0}, {1,0}, {0,0}, {0,0}, {0,1}, {0,0}, {1,1},
	{0,0}, {1,1}, {1,0}, {1,0}, {0,1}, {1,0}, {1,0}, {0,0}, {1,1}, {0,0},
	{0,1}, {0,0}, {1,0}, {1,0}, {0,0}, {0,0}, {0,0}, {0,1}, {1,0}, {0,0},
	{0,0}, {1,0}, {1,0}, {1,1}, {1,0}, {1,0}, {1,0}, {1,1}, {0,0}, {1,0},
	{1,1}, {1,1}, {0,0}, {0,0}, {0,1}, {1,1}, {1,1}, {1,0}, {1,1}, {0,1},
	{0,0}, {0,0}, {0,1}, {0,0}, {0,1}, {1,0}, {1,1}, {1,1}, {0,0}, {1,1},
	{1,1}, {0,0}, {1,1}, {1,1}, {0,1}, {0,1}, {0,1}, {1,0}, {0,1}, {1,0},
	{0,0}, {0,0}, {0,0}, {1,1}, {0,0}, {0,1}, {1,1}, {1,0}, {0,1}, {0,0},
	{1,1}, {0,1}, {0,1}, {0,0}, {0,1}, {0,1}, {1,0}, {1,0}, {0,0}, {1,0},
	{0,0}, {0,1}, {1,0}, {0,1}, {0,1}, {1,0}, {1,0}, {1,0}, {1,0}, {0,0},
	{1,0}, {1,0}, {1,0}, {1,0}, {1,1}, {0,0}, {0,1}, {0,1}, {1,1}, {0,0},
	{1,1}, {0,1}, {1,1}, {0,0}, {1,1}, {1,1}, {0,1}, {1,1}, {0,1}, {0,0},
	{0,0}, {0,0}, {1,1}, {0,1}, {1,1}, {0,1}, {0,1}, {0,0}, {0,0}, {0,0},
	{0,0}, {0,1}, {1,0}, {0,0}, {1,0}, {1,0}, {0,1}, {1,1}, {1,1}, {0,1},
	{1,1}, {1,1}, {1,1}, {1,1}, {0,0}, {0,1}, {1,1}, {1,1}, {1,0}, {1,0},
	{0,0}, {0,0}, {0,1}, {1,1}, {0,1}, {0,1}, {0,0}, {1,1}, {1,0}, {1,0},
	{1,1}, {1,1}, {1,0}, {0,0}, {1,1}, {1,0}, {0,1}, {0,1}, {0,0}, {1,0},
	{1,0}, {1,1}, {0,0}, {1,1}, {0,1}, {1,1}, {1,0}, {0,0}, {1,1}, {0,0},
	{1,1}, {0,0}, {0,1}, {0,0}, {0,0}, {1,0}, {1,0}, {0,1}, {0,1}, {1,0},
	{1,0}, {0,0}, {1,1}, {1,1}, {0,0}, {0,1}, {0,1}, {0,1}, {0,0}, {1,1},
	{1,0}, {0,0}, {0,0}, {0,1}, {0,0}, {0,1}, {0,1}, {0,1}, {0,1}, {1,0},
	{1,0}, {0,1}, {1,0}, {1,0}, {0,0}, {1,1}, {1,1}, {0,0}, {1,1}, {0,0},
	{1,0}, {1,1}, {1,1}, {0,0}, {1,1}, {0,1}, {1,1}, {1,0}, {1,0}, {1,0},
	{0,1}, {0,1}, {0,0}, {0,0}, {1,0}, {0,0}, {1,0}, {0,1}, {1,1}, {0,1},
	{0,0}, {1,1}, {0,1}, {0,0}, {0,1}, {0,1}, {1,1}, {0,0}, {1,1}, {1,1},
	{0,0}, {0,1}, {1,0}, {0,1}, {0,1}, {1,0}, {1,0}, {0,0}, {0,0}, {0,1},
	{0,0}, {0,1}, {1,1}, {0,1}, {0,1}, {0,1}, {1,0}, {0,0}, {0,1}, {1,1},
	{0,0}, {0,0}, {0,0}, {0,1}, {0,1}, {0,1}, {1,1}, {0,0}, {0,0}, {0,1},
	{0,1}, {0,1}, {0,1}, {0,1}, {0,1}, {0,1}, {1,0}, {0,0}, {0,0}, {1,0},
	{0,0}, {0,0}, {1,1}, {0,1}, {0,1}, {1,1}, {1,0}, {0,0}, {1,0}, {0,1},
	{0,0}, {1,0}, {1,0}, {0,1}, {1,0}, {0,1}, {1,1}, {1,0}, {1,1}, {1,1},
	{1,1}, {0,0}, {0,0}, {1,1}, {1,1}, {0,0}, {0,1}, {0,1}, {1,0}, {1,1},
	{1,1}, {1,0}, {1,1}, {0,0}, {0,1}, {1,0}, {0,0}, {0,1}, {0,1}, {1,1},
	{1,1}, {1,1}, {0,0}, {1,0}, {1,1}, {1,0}, {1,0}, {1,1}, {1,1}, {0,0},
	{0,1}, {0,0}, {0,0}, {1,1}, {1,0}, {1,0}, {0,0}, {0,0}, {0,0}, {0,0},
	{0,1}, {0,1}, {0,0},
};

int cacode(int chip, int sv)
{
	assert(sv >= 1 && sv <= MAX_SV);
	int g2chip = chip + SV[sv - 1].advance;
	if(g2chip >= 1023)
		g2chip -= 1023;
	return ca_code_states[chip].G1 ^ ca_code_states[g2chip].G2;
}
